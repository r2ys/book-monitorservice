# 链路监控

## 背景

微服务架构下，服务间的链路关系可能是单向，也可以是网状的。调用链的链路监控能帮助快速定位异常产生的服务点。涵盖前端-&gt;services-&gt;db等

上报应用调用信息的需求是对应用无侵入、异步高性能。

微服务的治理应该从设计开始就启动，将微服务应用通过无侵入的方式接入，构建一体化的全链路监控体系。避免后期对生产故障的定位费尽周折。

链路监控负责的职责通常包含全链路监控与应用性能管理。

链路监控应当提供分布式应用下完整的调用链路还原、调用请求量统计、链路拓扑、应用依赖分析，可以帮助开发者快速分析和诊断分布式应用架构下的性能瓶颈，提高微服务时代下的开发诊断效率。

### 链路跟踪的目标

对系统的监控最终目标都是能第一时间发现问题、定位问题、解决问题。

而调用链监控的诉求是可以清晰梳理整套系统的调用关系，并评判应用上下游依赖的合理性，同时了解每一个应用的性能指标，并对系统容量进行合理的规划，不论分布式系统哪个节点出现故障或异常都可以实时反馈。

### 链路监控功能需求

- 分布式调用链查询和诊断：追踪分布式架构中的所有微服务用户请求，并将它们汇总成分布式调用链。
- 应用性能实时汇总：通过追踪整个应用程序的用户请求，来实时汇总组成应用程序的单个服务和资源。
- 分布式拓扑动态发现：用户的所有分布式微服务应用和相关PaaS产品可以通过链路追踪收集到分布式调用信息。
- 多语言开发程序接入：基于OpenTracing标准，全面兼容开源社区，例如Jaeger、Zipkin。
- 丰富的下游对接场景：收集的链路可直接用于日志分析，且可对接到MaxCompute等下游分析平台。

#### 链路监控工作流程

1. 客户侧的应用程序通过集成链路追踪的多语言客户端SDK上报服务调用数据。链路追踪支持多种开源社区的SDK，且支持OpenTracing标准。
2. 数据上报至链路追踪控制台后，链路追踪组件进行实时聚合计算和持久化，形成链路明细、性能总览、实时拓扑等监控数据。您可以据此进行问题排查与诊断。
3. 调用链数据可对接下游产品，例如LogSearch、CloudMonitor、MaxCompute等，用于离线分析、报警等场景。

#### 链路监控架构

![](http://aliware-images.oss-cn-hangzhou.aliyuncs.com/arms/xtrace_dg_workflow.png)

### 链路追踪技术

[](https://help.aliyun.com/document_detail/90498.html?spm=a2c4g.11186623.6.545.210d1bc0HfooSL)

#### 特性

* 低侵入性：业务无侵入，使用方透明，接入极简
* 性能无影响：目标是客户系统cpu占用2%以下；优先推荐agent方式，其次是业务系统埋点
* 接入简单、配置全面：尽可能降低接入成本，提供灵活的监控配置策略，动态配置收集数据的范围和粒度
* 监控展示实时有效：通过监控数据可以理解系统行为，为流程、架构、代码优化，以及扩容缩容、服务限流降级提供正确客观的数据参考。

#### 技术细节

包括数据表示、埋点、传递、收集、存储与展示，核心概念有根据OpenTracing实现的跟踪树、Span、Trace、Annotation等。具体可参考谷歌早期的Dapper论文。优秀的全链路监控组件会尽可能的遵循OpenTracing标准，以获得更好的通用性以及扩展性。

**OpenTracing**

是一套统一的标准，让微服务体系中的所有应用遵循这套标准来实现跟踪信息的描述和传递，OpenTracing抽象出一套与编程语言以及业务逻辑无关的接口，对链路追踪领域各类元素的统一管理，保持对链路中每一个环节的记录与匹配，不仅在应用内部对跟踪信息进行传递，还让跟踪信息跨越不同的应用以及不同的分布式组件，从而实现完整的全链路监控。

**客户端实现方式**

业界的主流（非手动埋点）：

* SDK方式：通过引入链路追踪SDK自动生成链路数据，并自动上报。对于底层框架没有公开API的情况，监控逻辑的注入会比较复杂，有可能需要开发者针对具体的底层框架预先做好适配工作。

* 探针：不需要在代码编译前引入SDK，而是在应用运行的过程中，通过一个Agent动态的拦截底层框架的行为，从而自动注入监控逻辑。

采用探针的优点是不需要任何代码层面的改动，但并不是每一种编程语言都能提供探针机制，所以sdk方式也被很多全链路监控组件采用。

**框架采集**

信息采集依赖于链路追踪组件对于底层框架的识别。这些底层框架包含的领域非常广，其中包含：

* 应用对外提供服务所需要的框架
* 应用进程内部的通讯框架
* 应用之间相互访问所需要的框架
* 应用访问外部系统所需要的框架

java体系的范畴内包含：

* 用于提供HTTP服务的Tomcat、Jetty
* 用于进程内部通讯的RxJava
* 用于微服务应用之间相互调用的Feign
* 用于访问外部系统的MyBatis、MySQL JDBC、HTTPClient

对于多种编程语言以及种类繁多的底层框架的适配，是一项浩大的工程，一个全链路监控方案能够适配的底层框架越多，它的能力就越强大 ![](https://raw.githubusercontent.com/r2ys/upic_rep/main/uPic/v2-9e5d82c0f161412f99d7e1ef14e0c023_1440w.png)



**数据收集后的处理**

基础链路信息收集上来之后，需要进行统一存储，并对数据进行清洗与聚合，根据应用响应时间、请求数、错误率等指标进行下钻分析，并按应用、接口、链路、事务等多个维度进行展示。



## 技术方案比较【todo】

全链路监控方案的技术门槛非常高，在开源的全链路监控产品中，真正遵循OpenTracing标准，又够被广泛认可和使用的产品非常少，其中通过SDK方式接入的产品以Jaeger为代表，通过探针方式接入的产品以Skywalking为代表。

理想情况下，应当为每种语言的应用都提供sdk，支持多种数据库客户端。

* [zipkin](https://zipkin.io/)
* pinpoint
* skywalking
* cat

### zipkin

通用方案是采用sleuth+zipking，支持多语言。

输入端点可以通过记录本地文件、输出stdout、输出到Syslog、或者通过接口上报。

通过写文件的方式，输入测采用filebeat、可视化使用zipkin/kibana，目的是组件公用 sleuth+zipking










